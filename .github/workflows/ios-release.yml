name: iOS Release

on:
  push:
    tags: ['v*','ios-*']
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release-ios:
    runs-on: [self-hosted, macOS]

    steps:
      - uses: actions/checkout@v4

      # KHÔNG cài gì thêm; chỉ thêm PATH brew cho job
      - name: Add Homebrew to PATH (job)
        run: |
          [ -d /opt/homebrew/bin ] && echo /opt/homebrew/bin >> "$GITHUB_PATH"
          [ -d /usr/local/bin ]   && echo /usr/local/bin   >> "$GITHUB_PATH"

      - name: Verify toolchain (no install)
        run: |
          flutter --version
          xcodebuild -version
          pod --version

      - name: Derive build metadata
        run: |
          echo "BUILD_NAME=${GITHUB_REF_NAME#v}" >> "$GITHUB_ENV"
          echo "BUILD_NUMBER=${GITHUB_RUN_NUMBER}" >> "$GITHUB_ENV"

      - name: Pub get (prefer offline)
        run: flutter pub get --offline || flutter pub get

      # 1) Archive (không ký) — SINGLE LINE để tránh lỗi xuống dòng
      - name: Archive app (no codesign)
        run: flutter build ios --release --no-codesign --build-name "$BUILD_NAME" --build-number "$BUILD_NUMBER" || true

      # 2) Tự gói .ipa unsigned từ Runner.xcarchive
      - name: Make unsigned IPA from xcarchive
        id: makeipa
        shell: bash
        run: |
          set -e
          ARCHIVE="build/ios/archive/Runner.xcarchive"
          APP="$ARCHIVE/Products/Applications/Runner.app"
          OUT_DIR="build/ios/ipa"
          OUT_IPA="$OUT_DIR/Xanhnow-${BUILD_NAME}-${BUILD_NUMBER}-unsigned.ipa"

          mkdir -p "$OUT_DIR"
          if [ -d "$APP" ]; then
            rm -rf "$OUT_DIR/Payload"
            mkdir -p "$OUT_DIR/Payload"
            cp -R "$APP" "$OUT_DIR/Payload/Runner.app"
            (cd "$OUT_DIR" && /usr/bin/zip -qry "$OUT_IPA" Payload)
            echo "ipa=$OUT_IPA" >> "$GITHUB_OUTPUT"
            echo "Created unsigned IPA: $OUT_IPA"
          else
            echo "ipa=" >> "$GITHUB_OUTPUT"
            echo "Runner.app not found in xcarchive"
          fi

      # 3) Fallback: zip Runner.app nếu chưa có .ipa
      - name: Zip Runner.app (fallback)
        id: zapp
        if: ${{ steps.makeipa.outputs.ipa == '' }}
        shell: bash
        run: |
          set -e
          CANDIDATES=(
            "build/ios/archive/Runner.xcarchive/Products/Applications/Runner.app"
            "build/ios/iphoneos/Runner.app"
            "build/ios/Release-iphoneos/Runner.app"
            "build/ios/Debug-iphoneos/Runner.app"
          )
          OUT_ZIP="build/ios/Runner.app.zip"
          for P in "${CANDIDATES[@]}"; do
            if [ -d "$P" ]; then
              /usr/bin/zip -qry "$OUT_ZIP" "$P"
              echo "appzip=$OUT_ZIP" >> "$GITHUB_OUTPUT"
              echo "Zipped Runner.app at: $OUT_ZIP"
              exit 0
            fi
          done
          echo "appzip=" >> "$GITHUB_OUTPUT"
          echo "No Runner.app found to zip."

      # 4) Upload theo ưu tiên: IPA -> Runner.app.zip
      - name: Upload IPA (unsigned)
        if: ${{ steps.makeipa.outputs.ipa != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-unsigned
          path: ${{ steps.makeipa.outputs.ipa }}

      - name: Upload Runner.app.zip (fallback)
        if: ${{ steps.makeipa.outputs.ipa == '' && steps.zapp.outputs.appzip != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: ios-runner-app
          path: ${{ steps.zapp.outputs.appzip }}


