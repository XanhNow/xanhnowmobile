name: Android Release

on:
  push:
    tags: ["v*", "android-v*"]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write

defaults:
  run:
    shell: bash

jobs:
  android-release:
    runs-on: [self-hosted, Linux]   # sửa nếu label runner khác
    timeout-minutes: 45
    env:
      # Cờ boolean tránh dùng secrets.* trực tiếp trong if (đỡ VS Code cảnh báo)
      HAS_PLAY_STORE_JSON: ${{ secrets.PLAY_STORE_JSON != '' }}
      HAS_ANDROID_PACKAGE_NAME: ${{ vars.ANDROID_PACKAGE_NAME != '' }}

    steps:
      - uses: actions/checkout@v5

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Gradle (cache)
        uses: gradle/actions/setup-gradle@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      # ==== Preflight: kiểm tra secrets ký Android ====
      - name: Preflight secrets (Android signing)
        env:
          S1: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          S2: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          S3: ${{ secrets.ANDROID_KEY_ALIAS }}
          S4: ${{ secrets.ANDROID_KEY_ALIAS_PASSWORD }}
        run: |
          for v in S1 S2 S3 S4; do
            if [ -z "${!v}" ]; then
              echo "::error::Missing required Android signing secret: $v"
              echo "Need: ANDROID_KEYSTORE_BASE64 / ANDROID_KEYSTORE_PASSWORD / ANDROID_KEY_ALIAS / ANDROID_KEY_ALIAS_PASSWORD"
              exit 1
            fi
          done

      - name: Decode keystore & write key.properties
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_ALIAS_PASSWORD: ${{ secrets.ANDROID_KEY_ALIAS_PASSWORD }}
        run: |
          mkdir -p android/app
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > android/app/release.keystore
          cat > android/key.properties <<EOF
          storePassword=$ANDROID_KEYSTORE_PASSWORD
          keyPassword=$ANDROID_KEY_ALIAS_PASSWORD
          keyAlias=$ANDROID_KEY_ALIAS
          storeFile=app/release.keystore
          EOF

      - name: Dependencies
        run: flutter pub get

      - name: Build AAB (release)
        run: flutter build appbundle --release --build-number "$GITHUB_RUN_NUMBER"

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-aab-release
          path: build/app/outputs/bundle/release/*.aab
          retention-days: 30

      - name: Create GitHub Release (attach AAB)
        if: ${{ startsWith(github.ref, 'refs/tags/') }}
        uses: softprops/action-gh-release@v2
        with:
          files: build/app/outputs/bundle/release/*.aab
          generate_release_notes: true

      # ==== Optional: đẩy Play Internal nếu có đủ biến ====
      - name: Upload to Google Play (internal)
        if: ${{ env.HAS_PLAY_STORE_JSON == 'true' && env.HAS_ANDROID_PACKAGE_NAME == 'true' }}
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_JSON }}
          packageName: ${{ vars.ANDROID_PACKAGE_NAME }}
          releaseFiles: build/app/outputs/bundle/release/*.aab
          track: internal

      # ==== Cleanup nhạy cảm ====
      - name: Secure cleanup
        if: always()
        run: |
          rm -f android/app/release.keystore android/key.properties || true
